/*
Consulta — NTILE(): segmentação em grupos (quartis)

O que faz:
- NTILE(n) divide as linhas em n grupos de tamanho aproximadamente igual, com base na ordenação definida.
- Serve para criar “faixas” (top/médio/baixo) de performance sem calcular percentis manualmente.

Caso prático:
- Classificar vendedores em 4 quartis de performance por unidades vendidas.
- Como a ordenação é DESC, o grupo 1 representa os melhores (top) e o grupo 4 os piores (bottom).

Quando usar:
- Segmentação de performance (top 25%, meio, bottom 25%)
- Curva ABC / classificação de produtos/clientes por faixa
- Identificar top performers e low performers de forma rápida

Cuidados:
- Empates (mesmo valor) podem cair em grupos diferentes, porque o NTILE balanceia quantidade de linhas.
- Se quiser comparar tudo junto (sem separar por ano), remova o PARTITION BY ano.
- Requer banco com suporte a window functions (ex.: MySQL 8+, Postgres, SQL Server, Oracle).
*/


SELECT
    ano,
    funcionario,
    unidades_vendidas,
    NTILE(4) OVER (
        PARTITION BY ano
        ORDER BY unidades_vendidas DESC
    ) AS quartil_performance
FROM cap12.vendas;

/*
Consulta — Média móvel (Moving Average) com window functions

O que faz:
- Calcula uma média “deslizante” ao longo do tempo para suavizar variações e evidenciar tendência.

Versão A (centralizada): 1 anterior + atual + 1 próximo
- Boa para análise histórica e visualização (suavização mais “bonita”).
- Não é ideal para acompanhamento em tempo real, porque usa o “próximo” período (informação do futuro).

Versão B (somente passado): 2 anteriores + atual
- Boa para operação / monitoramento / análises que não podem usar dados futuros.
- Mais realista para acompanhamento e forecasting simples.

Cuidados:
- Se existir mais de uma linha por (funcionario, ano, mes), agregue antes para não distorcer a média.
- Requer MySQL 8+ (ou qualquer banco com suporte a window functions).
*/

-- Versão A: média móvel centralizada (anterior + atual + próximo)
SELECT
    funcionario,
    ano,
    mes,
    unidades_vendidas,
    ROUND(
        AVG(unidades_vendidas) OVER (
            PARTITION BY funcionario
            ORDER BY ano, mes
            ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING
        )
    , 2) AS media_movel_3p_centralizada
FROM cap12.vendas;

-- Versão B: média móvel usando apenas passado (2 anteriores + atual)
SELECT
    funcionario,
    ano,
    mes,
    unidades_vendidas,
    ROUND(
        AVG(unidades_vendidas) OVER (
            PARTITION BY funcionario
            ORDER BY ano, mes
            ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
        )
    , 2) AS media_movel_3p_passado
FROM cap12.vendas;
